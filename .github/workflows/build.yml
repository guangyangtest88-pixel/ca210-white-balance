name: Build Windows Application

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 检出代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 设置.NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    # 还原依赖
    - name: Restore dependencies
      run: dotnet restore

    # 编译解决方案
    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    # 发布为单文件可执行程序
    - name: Publish as single file
      run: |
        dotnet publish src/CA210WhiteBalance.UI/CA210WhiteBalance.UI.csproj ^
          --configuration Release ^
          --runtime win-x64 ^
          --self-contained true ^
          -p:PublishSingleFile=true ^
          -p:IncludeNativeLibrariesForSelfExtract=true ^
          -p:PublishReadyToRunShowWarnings=true ^
          --output publish

    # 上传可执行文件
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CA210WhiteBalance-win-x64
        path: publish/CA210WhiteBalance.exe
        retention-days: 90

    # 打包为zip（包含必要的配置文件）
    - name: Create Release Package
      run: |
        mkdir package
        copy publish\CA210WhiteBalance.exe package\
        copy src\CA210WhiteBalance.UI\NLog.config package\
        copy src\CA210WhiteBalance.UI\appsettings.json package\
        copy README.md package\
        7z a -tzip CA210WhiteBalance-win-x64.zip package\*

    # 上传zip包
    - name: Upload Zip Package
      uses: actions/upload-artifact@v4
      with:
        name: CA210WhiteBalance-win-x64-zip
        path: CA210WhiteBalance-win-x64.zip
        retention-days: 90

    # 创建GitHub Release（仅在tag时）
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: CA210WhiteBalance-win-x64.zip
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
