name: Build Windows Application

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  GITHUB_ACTIONS: "true"

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    # 编译UI项目（会自动编译依赖的Services项目）
    - name: Build UI project
      run: dotnet build src/CA210WhiteBalance.UI/CA210WhiteBalance.UI.csproj --configuration Release /p:WarningLevel=0

    # 发布为单文件可执行程序
    - name: Publish as single file
      run: |
        dotnet publish src/CA210WhiteBalance.UI/CA210WhiteBalance.UI.csproj ^
          --configuration Release ^
          --runtime win-x64 ^
          --self-contained true ^
          -p:PublishSingleFile=true ^
          -p:IncludeNativeLibrariesForSelfExtract=true ^
          -p:PublishReadyToRunShowWarnings=true ^
          --output publish

    # 创建发布包
    - name: Create Release Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path package
        Copy-Item publish\CA210WhiteBalance.exe package\
        Copy-Item src\CA210WhiteBalance.UI\NLog.config package\
        Copy-Item src\CA210WhiteBalance.UI\appsettings.json package\
        Copy-Item README.md package\
        Compress-Archive -Path package\* -DestinationPath CA210WhiteBalance-win-x64.zip

    # 上传zip包
    - name: Upload Zip Package
      uses: actions/upload-artifact@v4
      with:
        name: CA210WhiteBalance-win-x64-zip
        path: CA210WhiteBalance-win-x64.zip
        retention-days: 90
